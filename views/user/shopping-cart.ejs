<%- include('../partials/header') %>

<!-- breadcrumb -->
<div class="container">
    <div class="bread-crumb flex-w p-l-25 p-r-15 p-t-30 p-lr-0-lg">
        <a href="index.html" class="stext-109 cl8 hov-cl1 trans-04">
            Home
            <i class="fa fa-angle-right m-l-9 m-r-10" aria-hidden="true"></i>
        </a>
        <span class="stext-109 cl4">
            Shopping Cart
        </span>
    </div>
</div>

<!-- Shopping Cart -->

    <div class="container mt-5">
        <div class="row">
            <div class="col-lg-10 col-xl-7 m-lr-auto m-b-50">
                <div class="m-l-25 m-r--38 m-lr-0-xl">
                    <div class="wrap-table-shopping-cart">
                        <% if (cart.items && cart.items.length > 0) { %>
                        <table class="table-shopping-cart">
                            <tr class="table_head">
                                <th class="column-1">Product</th>
                                <th class="column-2"></th>
                                <th class="column-3">Price</th>
                                <th class="column-4">Quantity</th>
                                <th class="column-5">Size</th>
                                <th class="column-6">Total</th>
                                <th class="column-7">Actions </th>
                            </tr>

                           <!-- Loop through your cart items here -->
<% for (let i = 0; i < cart.items.length; i++) { %>
    <tr class="table_row">
        <td class="column-1">
            <div class="how-itemcart1">
                <img src="<%= cart.items[i].product.images && cart.items[i].product.images.length > 0 ? cart.items[i].product.images[0] : '/path/to/placeholder-image.jpg' %>" alt="Product Image">
            </div>
        </td>
        <td class="column-2"><%= cart.items[i].product ? cart.items[i].product.name : '' %></td>
        <td class="column-3">
            <%= cart.items[i].product ? ('Rs. ' + (cart.items[i].product.price || 0).toFixed(2)) : '' %>
        </td>
        <td class="column-4">
            <% const itemIndex = i + 1; %>
            <div class="wrap-num-product flex-w m-l-auto m-r-0">
                <div class="btn-num-product-down cl8 hov-btn3 trans-04 flex-c-m">
                    <i class="fs-16 zmdi zmdi-minus" data-index="<%= i %>" data-value="-1" data-item="<%= itemIndex %>" onclick="updateQuantityFromData(this)"></i>
                </div>
                <input class="mtext-104 cl3 txt-center num-product quantity-input" type="number" name="num-product<%= itemIndex %>" value="<%= cart.items[i].quantity %>" data-item="<%= itemIndex %>" data-unit-in-stock="<%= cart.items[i].product.inStock %>">
                <div class="btn-num-product-up cl8 hov-btn3 trans-04 flex-c-m">
                    <i class="fs-16 zmdi zmdi-plus" data-index="<%= i %>" data-value="1" data-item="<%= itemIndex %>" onclick="updateQuantityFromData(this)"></i>
                </div>
            </div>
        </td>
        <!-- Corrected the closing tag here -->
        <td class="column-5">
            <%= cart.items[i].product.size %>
        </td>


        <td class="column-6">
            <div class="how-itemcart1">
            <%= cart.items[i].product ? ('Rs. ' + ((cart.items[i].product.price || 0) * cart.items[i].quantity).toFixed(2)) : '' %>
        </div>
        </td>
        
        <form action="/user/cart/remove-product" method="post">
            <!-- Hidden input field for product ID -->
            <input type="hidden" name="productId" value="<%= cart.items[i].product._id %>">
            <!-- Other form fields... -->
            <td class="column-7">
                <button type="submit" class="btn">   <i class="zmdi zmdi-close"></i></button>
            </td>
        </form>
    </tr>
<% } /* End of cart items loop */ %>
<% } else { %>
    <p>Your cart is empty.</p>
<% } %>


                        </table>
                    </div>
                    <% console.log('Cart:', cart); %>
                    <% console.log('Cart Items:', cart.items); %>
                   
                    <div class="flex-w flex-sb-m bor15 p-t-18 p-b-15 p-lr-40 p-lr-15-sm">
                        <span class="stext-101 cl2 size-118">Sub Total:</span>
                        <span id="subtotal" class="stext-101 cl2 size-118" data-subtotal="<%= subtotal.toFixed(2) %>">Rs. <%= subtotal.toFixed(2) %></span>
                       
                    </div>
                     
                    <div class="row mt-5">
                        <div class="col-md-6">
                            <div class="coupon-box m-t-20">
                                <div class="coupon-info">
                                    <p class="coupon-title">Special Offer!</p>
                                    <p>Use coupon code <strong id="firstOrderCoupon">FIRSTORDER30</strong></p>
                                    <p>Get <strong>30% off</strong> on your order</p>
                                </div>
                                <button class="copy-coupon-btn" onclick="copyCouponCode('firstOrderCoupon')">Copy Coupon</button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="m-t-5 coupen-Wintersale">
                                <div class="coupon-info Wintersale">
                                    <p class="coupon-title">Winter Sale!</p>
                                    <p>Use coupon code <strong id="winterSaleCoupon">WINTERSALE</strong></p>
                                    <p>Get <strong>40% off</strong> on your order</p>
                                </div>
                                <button class="copy-coupon-btn" onclick="copyCouponCode('winterSaleCoupon')">Copy Coupon</button>
                                <p class="copy-instruction"></p>
                            </div>
                        </div>
                    </div>
                    
                                       
                </div>
            </div>
        </form> 
            
    
                <!-- Display Coupon Box -->
                <div class="col-sm-10 col-lg-7 col-xl-5 m-lr-auto m-b-50 ">
                    <div class="bor10 p-lr-40 p-t-30 p-b-40 m-l-63 m-r-40 m-lr-0-xl p-lr-15-sm">
                        <h4 class="mtext-109 cl3 p-b-30">
                            Cart Totals
                        </h4>
                        <div class="flex-w flex-t  p-b-13">
                            <div class="size-208">
                                <span class="stext-110 cl3">
                                    Subtotal:
                                </span>
                            </div>
                            <div class="size-209 ml-auto text-right">
                                <span id="subtotal" class="stext-101 cl3 size-118" data-subtotal="<%= subtotal.toFixed(2) %>">Rs. <%= subtotal.toFixed(2) %></span>
                            </div>
                        </div>
                        
                        <div class="flex-w flex-m m-r-8 m-tb-5">
                    

                        
                            
                                <!-- <form class="flex-w p-b-13" action="/user/cart/add-coupon" method="post"> -->
                                    <form class="flex-w p-b-13" action="/user/checkout" method="post">
                    
                                    <div id="couponFormWrapper" class="row">
                                
                                    <input class="stext-104 cl3 plh4 size-117 bor13 p-lr-20 m-r-10 m-tb-5" type="text" id="couponCode2" name="coupon" placeholder="Coupon Code">
                                        
                                    <!-- Apply coupon button -->
                                    <button type="button" id="applyCouponBtn" class="stext-101 cl3 size-118 bg8 bor13 hov-btn3 p-lr-8 trans-04 pointer m-tb-5">
                                        Apply coupon
                                    </button>
                                    
                            
                            </div>
                        </div>
                    
                            <!-- Existing code... -->
                        
                            <div class="flex-w flex-t bor12 p-t-15 p-b-30">
                                <div class="size-208 w-full-ssm">
                                    <span class="stext-110 cl2">
                                        Shipping Address:
                                    </span>
                                </div>
                        
                                <div class="size-209 p-r-18 p-r-0-sm w-full-ssm">
                                    <div class="rs1-select2 rs2-select2 bor8 bg0 m-b-12 m-t-9">
                                        <!-- <select class="js-select2" name="country">
                                            <option>Select a country...</option>
                                            <option>USA</option>
                                            <option>UK</option>
                                        </select> -->
                                        <div class="dropDownSelect2"></div>
                                    </div>
                        
                                    <div class="bor8 bg0 m-b-12">
                                        <input class="stext-111 cl8 plh3 size-111 p-lr-15" type="text" name="state" placeholder="State / Country" required>
                                    </div>
                        
                                    <div class="bor8 bg0 m-b-12">
                                        <input class="stext-111 cl8 plh3 size-111 p-lr-15" type="text" name="city" placeholder="City" required>
                                    </div>
                        
                                    <div class="bor8 bg0 m-b-22">
                                        <input class="stext-111 cl8 plh3 size-111 p-lr-15" type="text" name="postalCode" placeholder="Postcode / Zip" required>
                                    </div>
                        
                                    <div class="bor8 bg0 m-b-22">
                                        <input class="stext-111 cl8 plh3 size-111 p-lr-15" type="text" name="street" placeholder="Street Address" required>
                                    </div>
                                </div>
                            </div>
                        
                            <!-- Existing code... -->
                        
                            <div class="flex-w flex-t p-t-27 p-b-33">
                                <div class="size-208">
                                    <span class="mtext-101 cl2">
                                        Total:
                                    </span>
                                </div>
                        
                                <div class="size-209 p-t-1">
                                    <span class="mtext-110 cl2">
                                        <span id="discountedTotal" class="stext-101 cl2 size-118 m-l-25">Rs. <%= discountedTotal.toFixed(2) %></span>
                                    </span>
                                </div>
                            </div>
                            <input type="hidden" name="subtotal" value="<%= subtotal.toFixed(2) %>">
                            <input type="hidden" name="discountedTotal" value="<%= discountedTotal.toFixed(2) %>">
                        
                            <button class="flex-c-m stext-101 cl0 size-116 bg3 bor14 hov-btn3 p-lr-15 trans-04 pointer">
                                Proceed to Checkout
                            </button>
                        </form>
                        </div>
                        
                    </div>
                    
                </div>
                
                </div>
   








<script>
    $(document).ready(function () {
        // Use a conditional (ternary) operator to set a default value for subtotal
        var subtotal = parseFloat($('#subtotal').data('subtotal'));

        function updateQuantityAndTotal(itemIndex, newQuantity) {
            console.log('Before AJAX: newQuantity', newQuantity, 'itemIndex', itemIndex);
   // Check unit in stock before sending AJAX request
   var stockElement = $('.quantity-input[data-item="' + itemIndex + '"]');
        var unitInStock = parseInt(stockElement.data('unit-in-stock')) || 0;

        if (newQuantity > unitInStock) {
            console.log('Quantity exceeds available stock.');
            // Display an error message or take appropriate action
            return;
        }
            // Send an AJAX request to update quantity
            $.ajax({
                async: true,
                url: '/user/cart/update-quantity', // Update with your server endpoint
                type: 'POST',
                data: { itemIndex: itemIndex, newQuantity: newQuantity },
                success: function (response) {
                    console.log('AJAX Success: response', response);

                    updateSubtotal(response.newTotal);

                    // Update the total cell with the new total
                    var totalCell = $('#total' + itemIndex);
                    totalCell.text('$ ' + response.newTotal.toFixed(2));
                    location.reload();
                },
                error: function (error) {
                    console.error('Error updating quantity:', error);
                }
            });
        }

        // Function to update the subtotal
        function updateSubtotal(newTotal) {
            console.log('Updating Subtotal: newTotal', newTotal);
            $('#subtotal').text('$ ' + newTotal.toFixed(2));
        }

        // Event handler for quantity input change
        $('.quantity-input').on('change', function () {
            var newQuantity = parseInt($(this).val()) || 0;
            var itemIndex = $(this).data('item');
            updateQuantityAndTotal(itemIndex, newQuantity);
            
            
        });

        // Event handler for plus and minus buttons
        $('.btn-num-product-down, .btn-num-product-up').on('click', function () {
        var quantityInput = $(this).closest('.wrap-num-product').find('.quantity-input');
        var currentQuantity = parseInt(quantityInput.val()) || 0;
        var itemIndex = quantityInput.data('item');
        var valueChange = parseInt($(this).data('value')) || 0;
        var newQuantity = currentQuantity + valueChange;
        quantityInput.val(newQuantity); // Update quantity input
        updateQuantityAndTotal(itemIndex, newQuantity);
    });

    });


</script>


<script>
    // Function to copy coupon code to clipboard
    function copyCouponCode(elementId) {
        var couponCodeElement = document.getElementById(elementId);
        var couponCode = couponCodeElement.innerText;

        var tempInput = document.createElement('input');
        tempInput.value = couponCode;
        document.body.appendChild(tempInput);

        tempInput.select();
        document.execCommand('copy');
        document.body.removeChild(tempInput);

        // Display copy instruction
        var copyInstruction = document.querySelector('.copy-instruction');
        copyInstruction.innerText = 'Coupon code copied!';
    }

   
</script>
<script>
  $(document).ready(function () {
    var appliedCouponCode = '';

    $('#applyCouponBtn').on('click', function () {
        var couponCode = $('#couponCode2').val();

        if (appliedCouponCode) {
            // If a coupon is applied, remove it
            removeCoupon();
        } else {
            // Apply coupon logic
            applyCoupon(couponCode);
        }
    });

    function applyCoupon(couponCode) {
        // Calculate discounted total based on the coupon code
        var subtotal = parseFloat($('#subtotal').data('subtotal'));
        var discountedTotal;

        switch (couponCode) {
            case 'FIRSTORDER30':
                // Apply 30% discount for the first coupon
                discountedTotal = subtotal * 0.7;
                break;
            case 'WINTERSALE':
                // Apply 40% discount for the second coupon
                discountedTotal = subtotal * 0.6;
                break;
            // Add more cases for other coupons if needed

            default:
                // No coupon or unknown coupon code
                discountedTotal = subtotal;
                break;
        }

        // Update the total
        updateTotal(discountedTotal);

        // Display the applied coupon code
        appliedCouponCode = couponCode;
        $('#applyCouponBtn').text('Remove Coupon');
    }

    function removeCoupon() {
        // Reset the coupon input field
        $('#couponCode2').val('');

        // Reset the applied coupon code
        appliedCouponCode = '';

        // Recalculate total without the coupon
        var subtotal = parseFloat($('#subtotal').data('subtotal'));
        updateTotal(subtotal);

        // Change button text back to "Apply Coupon"
        $('#applyCouponBtn').text('Apply Coupon');
    }

    function updateTotal(total) {
        console.log('Updating Total: total', total);
        $('#discountedTotal').text('$ ' + total.toFixed(2));
    }

    // Your existing JavaScript code...
});

</script>


<style>
  
    .coupon-box {
        border: 1px solid #ddd;
        padding: 5px;
        text-align: left;
        max-width:2000px;
        margin: 0 auto;
        font-size:10px;
        background-color: #d9cbd7; /* Yellow background color */
    }

    .coupen-Wintersale{
        border: 1px solid #ffffff;
        padding: 5px;
        text-align: left;
        max-width:2000px;
        margin: 0 auto;
        font-size:10px;
        background-color: #d2f2fa;

    }
    .coupon-info {
        margin-bottom: 5px;
    }

    .coupon-title {
        color: #000000; /* Dark text color */
        font-weight: bold;
        font-size: 8px;
    }

    #couponCode {
        color: #000000; /* Red text color for the coupon code */
        cursor: pointer;
    }

    .copy-instruction {
        color: #ffffff; /* Blue text color for copy instruction */
        cursor: pointer;
    }
</style>


<style>
    /* Add custom styles to reduce the width of the coupon input */
    .stext-104 {
        width: 100px; /* Adjust the width as needed */
    }

    /* Add custom styles to reduce the width of the apply coupon button */
    .bg8 {
        width: 100px; /* Adjust the width as needed */
    }
  
   
    


</style>





t <%- include('../partials/footer') %>
