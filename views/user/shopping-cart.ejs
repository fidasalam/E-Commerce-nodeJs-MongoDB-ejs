<%- include('../partials/header') %>
<!-- Bootstrap CSS -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

<!-- Bootstrap JS -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<!-- breadcrumb -->
<div class="container">
    <div class="bread-crumb flex-w p-l-25 p-r-15 p-t-30 p-lr-0-lg">
        <a href="index.html" class="stext-109 cl8 hov-cl1 trans-04">
            Home
            <i class="fa fa-angle-right m-l-9 m-r-10" aria-hidden="true"></i>
        </a>
        <span class="stext-109 cl4">
            Shopping Cart
        </span>
    </div>
</div>

<!-- Shopping Cart -->

    <div class="container mt-5">
        <div class="row">
            <div class="col-lg-10 col-xl-7 m-lr-auto m-b-50">
                <div class="m-l-25 m-r--38 m-lr-0-xl">
                    <div class="wrap-table-shopping-cart">
                        <% if (cart.items && cart.items.length > 0) { %>
                        <table class="table-shopping-cart">
                            <tr class="table_head">
                                <th class="column-1">Product</th>
                                <th class="column-2"></th>
                                <th class="column-3">Price</th>
                                <th class="column-4">Quantity</th>
                                <th class="column-5">Size</th>
                                <th class="column-6">Total</th>
                                <th class="column-7"> </th>
                            </tr>

                           <!-- Loop through your cart items here -->
<% for (let i = 0; i < cart.items.length; i++) { %>
    <tr class="table_row">
        <td class="column-1">
            <div class="how-itemcart1">
                <img src="<%= cart.items[i].product.images && cart.items[i].product.images.length > 0 ? cart.items[i].product.images[0] : '/path/to/placeholder-image.jpg' %>" alt="Product Image">
            </div>
        </td>
        <td class="column-2"><%= cart.items[i].product ? cart.items[i].product.name : '' %></td>
        <td class="column-3">
            <%= cart.items[i].product ? ('₹ ' + (cart.items[i].product.price || 0).toFixed(0)) : '' %>
        </td>
        <td class="column-4">
            <% const itemIndex = i + 1; %>
            <% if (cart.items[i].product.inStock > 0) { %>
                <div class="wrap-num-product flex-w m-l-auto m-r-0">
                    <div class="btn-num-product-down cl8 hov-btn3 trans-04 flex-c-m">
                        <i class="fs-16 zmdi zmdi-minus" data-index="<%= i %>" data-value="-1" data-item="<%= itemIndex %>" onclick="updateQuantityFromData(this)"></i>
                    </div>
                    <input class="mtext-104 cl3 txt-center num-product quantity-input" type="number" name="num-product<%= itemIndex %>" value="<%= cart.items[i].quantity %>" data-item="<%= itemIndex %>" data-unit-in-stock="<%= cart.items[i].product.inStock %>" min="1">
                    <div class="btn-num-product-up cl8 hov-btn3 trans-04 flex-c-m">
                        <i class="fs-16 zmdi zmdi-plus" data-index="<%= i %>" data-value="1" data-item="<%= itemIndex %>" onclick="updateQuantityFromData(this)"></i>
                    </div>
                </div>
            <% } else { %>
                Out of Stock
            <% } %>
        </td>
        <!-- Corrected the closing tag here -->
        <td class="column-5">
            <%= cart.items[i].product.size %>
        </td>


        <td class="column-6">
            <div class="how-itemcart1">
            <%= cart.items[i].product ? ('₹ ' + ((cart.items[i].product.price || 0) * cart.items[i].quantity).toFixed(0)) : '' %>
        </div>
        </td>
        
        <form action="/user/cart/remove-product" method="post">
            <!-- Hidden input field for product ID -->
            <input type="hidden" name="productId" value="<%= cart.items[i].product._id %>">
            <!-- Other form fields... -->
            <td class="column-7">
                <button type="submit" class="btn">   <i class="zmdi zmdi-close"></i></button>
            </td>
        </form>
    </tr>
<% } /* End of cart items loop */ %>
<% } else { %>
    <p>Your cart is empty.</p>
<% } %>


                        </table>
                    </div>
                   
                   
                    <div class="flex-w flex-sb-m bor15 p-t-18 p-b-15 p-lr-40 p-lr-15-sm">
                        <span class="stext-101 cl2 size-118">Sub Total:</span>
                        <span id="subtotal" class="stext-101 cl2 size-118" data-subtotal="<%= subtotal.toFixed(0) %>">₹ <%= subtotal.toFixed(0) %></span>
                       
                    </div>
                     
                  
                </div>
            </div>
        </form> 
            
        <div id="popupMessage" class="popup-message">
            <span id="popupText" class="popup-text"></span>
        </div>
                
                <div class="col-sm-10 col-lg-7 col-xl-5 m-lr-auto m-b-50 ">
                    <div class="bor10 p-lr-40 p-t-30 p-b-40 m-l-63 m-r-40 m-lr-0-xl p-lr-15-sm">
                        <h4 class="mtext-109 cl3 p-b-30">
                            Cart Totals
                        </h4>
                        <div class="flex-w flex-t  p-b-13">
                            <div class="size-208">
                                <span class="stext-110 cl3">
                                    Subtotal:
                                </span>
                            </div>
                            <div class="size-209 ml-auto text-right">
                                <span id="subtotal" class="stext-101 cl3 size-118" data-subtotal="<%= subtotal.toFixed(0) %>">₹ <%= subtotal.toFixed(0) %></span>
                            </div>
                        </div>
                                                <!-- Button to trigger modal -->
<button type="button" class="flex-c-m stext-101 cl5 size-103 bg2 hov-btn1 p-lr-15 trans-04" id="showCouponModal">
    Show Coupon
</button>

                        <div class="flex-w flex-m m-r-8 m-tb-5">
                    



                            
                                <!-- <form class="flex-w p-b-13" action="/user/cart/add-coupon" method="post"> -->
                                    <form class="flex-w p-b-13" action="/user/checkout" method="post">
                    
                                 
                                     
                                        
                            <!-- Existing code... -->
                        
                            <div class="flex-w flex-t bor12 p-t-15 p-b-30">
                                <div class="size-208 w-full-ssm">
                                    <span class="stext-110 cl2">
                                        Shipping Address:
                                    </span>
                                </div>
                        
                                <div class="size-209 p-r-18 p-r-0-sm w-full-ssm">
                                    <div class="rs1-select2 rs2-select2 bor8 bg0 m-b-12 m-t-9">
                                        <!-- <select class="js-select2" name="country">
                                            <option>Select a country...</option>
                                            <option>USA</option>
                                            <option>UK</option>
                                        </select> -->
                                        <div class="dropDownSelect2"></div>
                                    </div>
                        
                                    <div class="bor8 bg0 m-b-12">
                                        <input class="stext-111 cl8 plh3 size-111 p-lr-15" type="text" name="state" placeholder="State "  required>
                                    </div>
                        
                                    <div class="bor8 bg0 m-b-12">
                                        <input class="stext-111 cl8 plh3 size-111 p-lr-15" type="text" name="city" placeholder="City"  required>
                                    </div>
                        
                                    <div class="bor8 bg0 m-b-22">
                                        <input class="stext-111 cl8 plh3 size-111 p-lr-15" type="text" name="postalCode" placeholder="Postcode"  required>
                                    </div>
                        
                                    <div class="bor8 bg0 m-b-22">
                                        <input class="stext-111 cl8 plh3 size-111 p-lr-15" type="text" name="street" placeholder="Street Address"  required>
                                    </div>
                                </div>
                            </div>
                        
                            <!-- Existing code... -->
                        
                            <div class="flex-w flex-t p-t-27 p-b-33">
                                <div class="size-208">
                                    <span class="mtext-101 cl2">
                                        Total:
                                    </span>
                                </div>
                        
                                <div class="size-209 p-t-1">
                                    <span class="mtext-110 cl2">
                                        <span id="discountedTotal" class="stext-101 cl2 size-118 m-l-25">₹ <%= discountedTotal.toFixed(0) %></span>
                                    </span>
                                </div>
                            </div>
                            <input type="hidden" name="subtotal" value="<%= subtotal.toFixed(0) %>">
                            <input type="hidden" name="discountedTotal" value="<%= discountedTotal.toFixed(0) %>">
                        
                            <button class="flex-c-m stext-101 cl0 size-116 bg3 bor14 hov-btn3 p-lr-15 trans-04 pointer">
                                Proceed to Checkout
                            </button>
                        </form>
                        </div>
                        
                    </div>
                    
                </div>
                
                </div>
   
</div>


  <!-- Modal -->
<div class="modal fade" id="couponModal" tabindex="-1" role="dialog" aria-labelledby="couponModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="couponModalLabel">Coupon Available</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="couponContent">
                <!-- Coupon information will be dynamically populated here -->
            </div>
           
        </div>
    </div>
</div>

<script>
  $(document).ready(function () {
    $('#showCouponModal').click(function () {
        // AJAX call to fetch coupons from the server
        $.ajax({
            url: '/user/coupons', // Update with your server endpoint
            type: 'POST',
            success: function (response) {
                // Check if a coupon is returned
                if (response.coupon) {
                    // Populate the coupon information in the modal
                    $('#couponContent').html('<div class="coupon-box">' +
                        '<p><strong>' + response.coupon.code + '</strong></p>' +
                        '<p>' + response.coupon.description + '</p>'  +
                        '<button id="applyCouponBtn" data-code="' + response.coupon.code + '">Apply</button>' +
                        '</div>');
                    $('#couponModal').modal('show');

                    // Bind click event to apply coupon button
                    $('#applyCouponBtn').click(function () {
                        var couponCode = $(this).data('code');
                        // Perform further action here like applying the coupon
                        // For demonstration purposes, you can just log the selected coupon code
                        console.log('Applying coupon:', couponCode);
                    });
                } else {
                    showPopupMessage('No coupons available.');
             } },
            error: function (error) {
                console.error('Error fetching coupons:', error);
            }
        });
    });
    function showPopupMessage(message) {
        $('#popupText').text(message);
        $('#popupMessage').fadeIn().delay(3000).fadeOut();
    }

       // Bind click event to apply coupon button
       $(document).on('click', '#applyCouponBtn', function () {
        var couponCode = $(this).data('code');
        // AJAX call to apply the coupon
        $.ajax({
            url: '/user/apply-coupon', // Update with your server endpoint
            type: 'POST',
            data: { couponCode: couponCode },
            success: function (response) {
                // Handle success response
                if (response.discountedTotal) {
                    // Update the total with the discounted total
                    $('#discountedTotal').text('₹' + response.discountedTotal.toFixed(0));
                    // Hide the modal after applying the coupon
                    $('#couponModal').modal('hide');
                }
                showPopupMessage('Coupon applied');
            },
            error: function (error) {
                console.error('Error applying coupon:', error);
            }
        });
    });
});



</script>





<script>
    $(document).ready(function () {
        // Use a conditional (ternary) operator to set a default value for subtotal
        var subtotal = parseFloat($('#subtotal').data('subtotal'));

        function updateQuantityAndTotal(itemIndex, newQuantity) {
            console.log('Before AJAX: newQuantity', newQuantity, 'itemIndex', itemIndex);
            if (newQuantity < 1) {
        console.log('Quantity cannot be less than 1.');
        return;
    }
   // Check unit in stock before sending AJAX request
   var stockElement = $('.quantity-input[data-item="' + itemIndex + '"]');
        var unitInStock = parseInt(stockElement.data('unit-in-stock')) || 0;

        if (newQuantity > unitInStock) {
            console.log('Quantity exceeds available stock.');
            alert('Quantity exceeds available stock. Please choose a lower quantity.');
            // Display an error message or take appropriate action
            return;
        }
            // Send an AJAX request to update quantity
            $.ajax({
                async: true,
                url: '/user/cart/update-quantity', // Update with your server endpoint
                type: 'POST',
                data: { itemIndex: itemIndex, newQuantity: newQuantity },
                success: function (response) {
                    console.log('AJAX Success: response', response);

                    updateSubtotal(response.newTotal);

                    // Update the total cell with the new total
                    var totalCell = $('#total' + itemIndex);
                    totalCell.text('₹ ' + response.newTotal.toFixed(2));
                    location.reload();
                },
                error: function (error) {
                    console.error('Error updating quantity:', error);
                }
            });
        }

        // Function to update the subtotal
        function updateSubtotal(newTotal) {
            console.log('Updating Subtotal: newTotal', newTotal);
            $('#subtotal').text('₹ ' + newTotal.toFixed(2));
        }

        // Event handler for quantity input change
        $('.quantity-input').on('change', function () {
            var newQuantity = parseInt($(this).val()) || 0;
            var itemIndex = $(this).data('item');
            updateQuantityAndTotal(itemIndex, newQuantity);
            
            
        });

        // Event handler for plus and minus buttons
        $('.btn-num-product-down, .btn-num-product-up').on('click', function () {
        var quantityInput = $(this).closest('.wrap-num-product').find('.quantity-input');
        var currentQuantity = parseInt(quantityInput.val()) || 0;
        var itemIndex = quantityInput.data('item');
        var valueChange = parseInt($(this).data('value')) || 0;
        var newQuantity = currentQuantity + valueChange;
          if (newQuantity < 1) {
        newQuantity = 1;
    }

        quantityInput.val(newQuantity); // Update quantity input
        updateQuantityAndTotal(itemIndex, newQuantity);
    });

 
    });


</script>

<style>
    /* Popup message styles */
.popup-message {
    display: none;
    position: fixed;
    bottom: 60px;
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(0, 0, 0, 0.8);
    color: #fff;
    padding: 10px 20px;
    border-radius: 5px;
    z-index: 9999;
}

.popup-text {
    font-size: 16px;
    color: #ffffff;
}

    /* Customize modal appearance */
    .modal-content {
        background-color: #ffffff;
        border-radius: 10px;
        color: #000000;
    }

    /* Customize modal header */
    .modal-header {
        border-bottom: none;
    }

    /* Customize modal title */
    .modal-title {
        color: #000000;
        font-size: 1.5rem;
        font-weight: bold;
    }

    /* Customize modal body */
    .modal-body {
        padding: 20px;
    }
    #applyCouponBtn{
    
        color: #fff;
    background-color: #2a7cbf;
    border-color: #000000;
    padding: 10px 20px; /* Adjust padding for better appearance */
    border-radius: 5px; /* Add border-radius for rounded corners */
    cursor: pointer; /
    }

    /* Customize modal footer */
    .modal-footer {
        border-top: none;
        justify-content: flex-end;
    }

    .modal-dialog {
    position: absolute;
    left: 50%;
    top: 20%;
    transform: translate(-50%, -50%);
}
    /* Customize modal close button */
    .close {
        color: #333;
        font-size: 1.5rem;
    }
 
</style>



 <%- include('../partials/footer') %>
